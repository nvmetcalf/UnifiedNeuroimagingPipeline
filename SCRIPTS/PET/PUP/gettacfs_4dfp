#!/bin/bash
#
# Script to obtain ROI TACs using freesurfer ROIs.
#
# Yi Su, 12/22/2011

petfstr=$1 # pet 4dfp data
t4file=$2 # pet to mr t4 file
mask=$3 # mask that determine where to sample the PET data in the MR space
RSFMask=$4 #RSFMask, ROIlist, and WBMask are generated by preprocessing wmparc
ROIlist=$5
WBMask=$6

petname=`basename $petfstr`
petdir=`dirname $petfstr`
petroot=${petname%%.*}



# Transform individual frames and quantify ROI intensity
if [ -e ${petroot}_WB.tac ]
then
	rm ${petroot}_WB.tac
fi
touch ${petroot}_WB.tac


frames=`gawk '/matrix size \[4\]/ {print $5}' $petdir"/"$petroot".4dfp.ifh"`
for (( f=1; f<=frames; f++ ))
do
echo 1
	chop_4dfp $petfstr $f $f -o${petroot}"_"$f
	t4img_4dfp $t4file ${petroot}"_"$f  ${petroot}"_"$f"_on_MR" -OT1001 # Transform the frame to MR space
	NROI=`wc -l $ROIlist | gawk '{print $1}'`
echo 1
	roieval ${petroot}"_"$f"_on_MR" $RSFMask  $mask $ROIlist $NROI ${petroot} $f
	qnt_4dfp ${petroot}"_"$f"_on_MR" $WBMask | gawk '/Mean/ {print $2}' >> ${petroot}_WB.tac
	rm ${petroot}"_"${f}.*
	rm ${petroot}"_"${f}_on_MR.*
done

# Generate TAC files
lines=`wc -l ${petroot}"_ROI3_f1" | gawk '{print $1}'`
l=2
echo "l=${l}; lines=${lines}"
((lines++))
 
while (( $l < $lines ))
do
	label=`gawk 'NR=='$l' {print $1}'  ${petroot}"_ROI3_f1"`
	echo "label = ${label}"
	outfile=${petroot}"_"${label}".tac"
	echo "outfile = ${outfile}"
	if [ -e $outfile ]
	then
		rm $outfile
	fi
	touch $outfile
	
	NVOX=`gawk 'NR=='$l' {print $2}'  ${petroot}"_ROI3_f1"`
	printf "%9s %15s %15s %15s  %15s%10d\n" "Frame_#" "Start_Time_(s)" "Duration_(s)"  "Mean"  "NVoxels=" $NVOX>> $outfile
	f=1
	f1=1
	while (( $f <= $frames ))
	do
		ROIfn=${petroot}"_ROI3_f"$f
		if [ -e $ROIfn  ] 
		then
			ts=`gawk 'NR=='$f1' {print $1}'  ${petroot}".info"`
			td=`gawk 'NR=='$f1' {print $3}'  ${petroot}".info"`
			meanroi=`gawk 'NR=='$l' {print $3}' $ROIfn `
			printf "%9d %15f %15f %15f\n" $f $ts $td $meanroi >> $outfile
			((f1++))
		fi
		((f++))
		
	done
	((l++))
done
